# LangGraph Flow Logic

## Overview
Two separate graphs handle different conversation phases:
1. **Initial Graph** - First user message (new complaint)
2. **Continuation Graph** - Follow-up messages (answering questions)

---

## 1. Initial Complaint Graph (First Message)

**Legend:**
- `[LLM]` = AI-powered node (calls OpenAI)
- `{CONDITION}` = Conditional routing (rule-based decision)
- `[RULE]` = Rule-based processing node

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          START                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ [LLM] VALIDATE ‚îÇ  ‚Üê AI checks if input is a complaint
         ‚îÇ  (validateInput)‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ {CONDITION}         ‚îÇ
        ‚îÇ  needsMoreInfo?     ‚îÇ  ‚Üê Rule: Check boolean flag
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ NO           YES ‚îÇ
         ‚îÇ              ‚Üì   ‚îÇ
         ‚ñº            [END] ‚îÇ ‚Üê Ask clarifying question, wait for user
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ [LLM] CLASSIFY  ‚îÇ         ‚îÇ
‚îÇ(classifyComplaint)‚îÇ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚Üê AI categorizes: domain/subcategory/impact
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [LLM] DETERMINE      ‚îÇ  ‚Üê AI identifies missing required fields
‚îÇ      MISSING         ‚îÇ
‚îÇ(determineMissingFields)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ {CONDITION}          ‚îÇ
  ‚îÇ  missingFields > 0?  ‚îÇ  ‚Üê Rule: Check array length
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ YES      NO ‚îÇ
      ‚îÇ          ‚Üì  ‚îÇ
      ‚ñº       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
‚îÇ [LLM] ASK        ‚îÇ             ‚îÇ
‚îÇ    QUESTION      ‚îÇ             ‚îÇ
‚îÇ(askClarifyingQuestion)‚îÇ        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
          ‚îÇ                      ‚ñº
          ‚ñº             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        [END]           ‚îÇ [LLM] GENERATE   ‚îÇ  ‚Üê AI creates closing message
     Wait for user      ‚îÇ      FINAL       ‚îÇ
                        ‚îÇ(generateFinalResponse)‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                                 ‚ñº
                               [END]
                            Conversation
                             complete
```

### Decision Points (Initial Graph)

| Node | Decision Logic | Outcomes |
|------|---------------|----------|
| **validate** | `state.needsMoreInfo?` | YES ‚Üí END, NO ‚Üí classify |
| **determineMissing** | `state.missingFields.length > 0?` | YES ‚Üí askQuestion, NO ‚Üí generateFinal |

---

## 2. Continuation Graph (Follow-up Messages)

**Legend:**
- `[LLM]` = AI-powered node (calls OpenAI)
- `{CONDITION}` = Conditional routing (rule-based decision)
- `[RULE]` = Rule-based processing node

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          START                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ [RULE] RESET   ‚îÇ  ‚Üê Clear needsMoreInfo flag
         ‚îÇ   (resetState) ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ {CONDITION}          ‚îÇ
        ‚îÇ  Has subcategory?    ‚îÇ  ‚Üê Rule: Check if complaint.subcategory exists
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ NO           YES ‚îÇ
         ‚îÇ              ‚Üì   ‚îÇ
         ‚ñº         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ [LLM]        ‚îÇ  ‚Üê AI extracts data from user answer
‚îÇ [LLM] VALIDATE  ‚îÇ‚îÇ  INTERPRET   ‚îÇ
‚îÇ  (validateInput)‚îÇ‚îÇ(interpretUserResponse)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                ‚îÇ
         ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [LLM] CLASSIFY  ‚îÇ‚îÇ [RULE] UPDATE    ‚îÇ  ‚Üê Merge extracted data into complaint
‚îÇ(classifyComplaint)‚îÇ‚îÇ(updateComplaintFromUserReply)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                    ‚îÇ
         ‚îÇ                    ‚ñº
         ‚îÇ       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ       ‚îÇ [LLM] VALIDATE         ‚îÇ  ‚Üê AI verifies data quality
         ‚îÇ       ‚îÇ      EXTRACTED         ‚îÇ
         ‚îÇ       ‚îÇ(validateExtractedData) ‚îÇ
         ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                  ‚îÇ
         ‚îÇ                  ‚ñº
         ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ         ‚îÇ {CONDITION}          ‚îÇ
         ‚îÇ         ‚îÇ   needsMoreInfo?     ‚îÇ  ‚Üê Rule: Data invalid/incomplete?
         ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                    ‚îÇ
         ‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ            ‚îÇ YES       NO ‚îÇ
         ‚îÇ            ‚îÇ ‚Üì            ‚îÇ
         ‚îÇ          [END]           ‚îÇ
         ‚îÇ       Ask for            ‚îÇ
         ‚îÇ      clarification       ‚îÇ
         ‚îÇ                          ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ [LLM] DETERMINE       ‚îÇ  ‚Üê AI re-checks what's still needed
       ‚îÇ      MISSING          ‚îÇ
       ‚îÇ(determineMissingFields)‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ {CONDITION}          ‚îÇ
         ‚îÇ  missingFields > 0?  ‚îÇ  ‚Üê Rule: Check array length
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ YES        NO ‚îÇ
           ‚îÇ            ‚Üì  ‚îÇ
           ‚ñº       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ [LLM] GENERATE   ‚îÇ
‚îÇ [LLM] ASK        ‚îÇ‚îÇ      FINAL       ‚îÇ
‚îÇ    QUESTION      ‚îÇ‚îÇ(generateFinalResponse)‚îÇ
‚îÇ(askClarifyingQuestion)‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
          ‚îÇ                     ‚ñº
          ‚ñº                   [END]
        [END]              Conversation
     Ask next               complete
     question
```

### Decision Points (Continuation Graph)

| Node | Decision Logic | Outcomes |
|------|---------------|----------|
| **reset** | `state.complaint.subcategory exists?` | YES ‚Üí interpret, NO ‚Üí validate |
| **validate** | `state.needsMoreInfo?` | YES ‚Üí END, NO ‚Üí classify |
| **validateExtracted** | `state.needsMoreInfo?` | YES ‚Üí END, NO ‚Üí determineMissing |
| **determineMissing** | `state.missingFields.length > 0?` | YES ‚Üí askQuestion, NO ‚Üí generateFinal |

---

## Key Differences Between Graphs

| Aspect | Initial Graph | Continuation Graph |
|--------|--------------|-------------------|
| **Entry Point** | Always validate | Reset ‚Üí check if classified |
| **Classification** | Always classify after validate | Only if not already classified |
| **Data Extraction** | Built into classify | Explicit interpret ‚Üí update ‚Üí validateExtracted |
| **Purpose** | Understand new complaint | Extract info from answer |

---

## Node Type Breakdown

### ü§ñ LLM-Powered Nodes (AI Processing)
**Calls:** `await llm.invoke(prompt)` - Makes OpenAI API call

| Node | Function | What AI Does | Latency Impact |
|------|----------|--------------|----------------|
| `validateInput` | Check if input is complaint-related | Analyzes text intent | ~2-3s |
| `classifyComplaint` | Categorize complaint | Maps to domain/subcategory/impact | ~2-3s |
| `determineMissingFields` | Identify missing required fields | Compares extracted vs required fields | ~2-3s |
| `askClarifyingQuestion` | Generate context-aware question | Creates natural question (max 5 total) | ~2-3s |
| `interpretUserResponse` | Extract structured data from free text | Parses answer into structured fields | ~2-3s |
| `validateExtractedData` | Verify data quality | Checks if answer is valid/usable | ~2-3s |
| `generateFinalResponse` | Create closing message | Composes empathetic final message | ~2-3s |

**Total LLM nodes per conversation:** 3-7 calls (depending on follow-ups)

---

### üìä Conditional Routing (Rule-Based Decisions)
**Logic:** Pure JavaScript boolean/comparison checks - **instant (< 1ms)**

| Decision Point | Rule | Outcomes |
|----------------|------|----------|
| After `validate` | `state.needsMoreInfo === true` | YES ‚Üí END, NO ‚Üí classify |
| After `reset` | `state.complaint.subcategory !== undefined` | YES ‚Üí interpret, NO ‚Üí validate |
| After `validateExtracted` | `state.needsMoreInfo === true` | YES ‚Üí END, NO ‚Üí determineMissing |
| After `determineMissing` | `state.missingFields.length > 0` | YES ‚Üí askQuestion, NO ‚Üí generateFinal |

**Implementation:** Uses `addConditionalEdges()` with JavaScript functions like:
```typescript
function shouldAskQuestion(state: GraphState): string {
  if (state.missingFields && state.missingFields.length > 0) {
    return "askQuestion";
  }
  return "generateFinal";
}
```

---

### ‚öôÔ∏è Rule-Based Processing Nodes (Deterministic Logic)
**Logic:** JavaScript data manipulation - **instant (< 1ms)**

| Node | Function | What It Does |
|------|----------|--------------|
| `resetState` | Clear `needsMoreInfo` flag | Sets `needsMoreInfo = false` to prepare for next turn |
| `updateComplaintFromUserReply` | Merge extracted data | Object spread: `{ ...complaint, ...extractedData }` |

---

### Performance Comparison

| Node Type | Count per Session | Avg Time | % of Total Latency |
|-----------|------------------|----------|-------------------|
| **LLM Nodes** | 3-7 | ~2384ms each | **92%** |
| **Conditional Routing** | 4-8 | < 1ms each | **< 0.1%** |
| **Rule-Based Nodes** | 1-3 | < 1ms each | **< 0.1%** |
| **TTS (post-LLM)** | 1 | ~203ms | **8%** |

**Key Insight:** LLM nodes dominate latency (92%). Routing and rule-based logic is negligible.

---

## State Object (Passed Between Nodes)

```typescript
interface GraphState {
  messages: BaseMessage[];        // Conversation history
  complaint: ComplaintData;       // Structured complaint data
  missingFields: string[];        // Fields still needed
  currentQuestion?: string;       // Last question asked
  isComplete: boolean;           // Conversation finished?
  needsMoreInfo: boolean;        // Need clarification?
  fieldAttempts: Record<string, number>;  // Track question count per field
  sessionId: string;             // Unique conversation ID
}
```

Each node reads the state, performs its logic, and returns updated state fields.

---

## Interview Talking Points

### 1. **Progressive Questioning Strategy**
- Max 5 questions total per conversation
- Asks ONE field at a time (not bundled)
- Tracks `fieldAttempts` to avoid repeating questions
- Explicitly allows "don't know" responses

### 2. **Hybrid Architecture**
- **LLM for understanding**: Natural language ‚Üí structured data
- **Rules for control flow**: When to ask, when to finish
- Keeps latency predictable while maintaining conversational quality

### 3. **Stateful Conversation**
- Session state persists across turns
- Continuation graph picks up where initial graph left off
- No re-classification on follow-ups (efficiency)

### 4. **Error Handling**
- `needsMoreInfo` flag triggers END to wait for user clarification
- `validateExtractedData` ensures data quality before proceeding
- Graceful degradation (continues even if fields missing)

### 5. **Outcome Validation**
Valid outcome = `isComplete` OR `(userProvidedInfo && missingFields ‚â§ 2)`
- Flexible definition: doesn't require 100% field coverage
- Balances data completeness with user experience
